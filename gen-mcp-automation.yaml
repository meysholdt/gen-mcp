name: gen-mcp-from-openapi
description: Create a GitHub repo, generate an MCP server from an OpenAPI spec, set up a devcontainer, and push everything.
triggers:
  - context:
      projects: {}
    manual: {}
action:
  limits:
    maxParallel: 1
    maxTotal: 10
  steps:
    - task:
        command: |
          GITHUB_TOKEN=$(git credential-helper github.com 2>/dev/null | grep password | cut -d= -f2)
          if [ -z "$GITHUB_TOKEN" ]; then
            GITHUB_TOKEN=$(git config --get-regexp 'credential\..*\.helper' | head -1 | sed 's/.*!f() { cat '"'"'\(.*\)'"'"'; }; f/\1/' | xargs grep password | cut -d= -f2)
          fi
          curl -fsSL -X POST https://api.github.com/user/repos \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -d '{"name":"{{.Parameters.repo_name}}","auto_init":true}' &&
          git clone https://github.com/meysholdt/{{.Parameters.repo_name}}.git
    - task:
        command: |
          cd {{.Parameters.repo_name}} &&
          mkdir -p .devcontainer &&
          cat > .devcontainer/devcontainer.json << 'EOF'
          {
            "name": "MCP Server",
            "image": "mcr.microsoft.com/devcontainers/javascript-node:22-bookworm",
            "postCreateCommand": "cd generated-mcp-server && pnpm install && pnpm run build"
          }
          EOF
          git add .devcontainer &&
          git commit -m "Add devcontainer configuration" &&
          git push
    - task:
        command: |
          cd {{.Parameters.repo_name}} &&
          curl -fsSL https://raw.githubusercontent.com/stefanwille/openapi-generator-typescript-example/master/json-placeholder-api.yaml -o json-placeholder-api.yaml
    - task:
        command: |
          mkdir -p /tmp/gen-tools &&
          cd /tmp/gen-tools &&
          pnpm init &&
          pnpm add openapi-mcp-generator
    - task:
        command: |
          cd {{.Parameters.repo_name}} &&
          /tmp/gen-tools/node_modules/.bin/openapi-mcp-generator \
            -i json-placeholder-api.yaml \
            -o generated-mcp-server \
            -b https://jsonplaceholder.typicode.com \
            -t stdio \
            --force
    - task:
        command: |
          cd {{.Parameters.repo_name}}/generated-mcp-server &&
          pnpm install &&
          pnpm run build
    - agent:
        prompt: |-
          The MCP server has been generated and built in {{.Parameters.repo_name}}/generated-mcp-server/.
          Write and run a test script that verifies the server works:
          - Use @modelcontextprotocol/sdk to connect via StdioClientTransport
          - The server binary is at {{.Parameters.repo_name}}/generated-mcp-server/build/index.js
          - List tools and confirm getPosts and getPost exist
          - Call getPost with id=1 and confirm the response contains "Status: 200"
          - Print "All tests passed" on success, exit non-zero on failure
    - task:
        command: |
          cd {{.Parameters.repo_name}} &&
          echo "node_modules/" > .gitignore &&
          echo "build/" >> .gitignore &&
          git add -A &&
          git commit -m "Add generated MCP server from OpenAPI spec" &&
          git push
