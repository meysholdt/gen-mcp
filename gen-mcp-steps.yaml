- task:
    command: |
      REPO_DIR=$(basename "{{.Parameters.repo_name}}") &&
      git config --get-regexp 'credential\..*\.helper' | head -1 | sed 's/.*!f() { cat '"'"'\(.*\)'"'"'; }; f/\1/' | xargs grep password | cut -d= -f2 | gh auth login --with-token &&
      cd /workspaces &&
      gh repo create {{.Parameters.repo_name}} --public --clone &&
      cd "$REPO_DIR" &&
      git checkout -b main
- task:
    command: |
      REPO_DIR=/workspaces/$(basename "{{.Parameters.repo_name}}") &&
      cd "$REPO_DIR" &&
      mkdir -p .devcontainer &&
      cat > .devcontainer/devcontainer.json << 'EOF'
      {
        "name": "MCP Server",
        "image": "mcr.microsoft.com/devcontainers/javascript-node:22-bookworm",
        "postCreateCommand": "cd generated-mcp-server && pnpm install && pnpm run build"
      }
      EOF
      git add .devcontainer &&
      git commit -m "Add devcontainer configuration" &&
      git push
- task:
    command: |
      REPO_DIR=/workspaces/$(basename "{{.Parameters.repo_name}}") &&
      cd "$REPO_DIR" &&
      curl -fsSL "{{.Parameters.openapi_url}}" -o openapi-spec.yaml
- task:
    command: |
      mkdir -p /tmp/gen-tools &&
      cd /tmp/gen-tools &&
      pnpm init &&
      pnpm add openapi-mcp-generator
- task:
    command: |
      REPO_DIR=/workspaces/$(basename "{{.Parameters.repo_name}}") &&
      cd "$REPO_DIR" &&
      /tmp/gen-tools/node_modules/.bin/openapi-mcp-generator \
        -i openapi-spec.yaml \
        -o generated-mcp-server \
        -b https://jsonplaceholder.typicode.com \
        -t stdio \
        --force
- task:
    command: |
      REPO_DIR=/workspaces/$(basename "{{.Parameters.repo_name}}") &&
      cd "$REPO_DIR/generated-mcp-server" &&
      pnpm install &&
      pnpm run build
- agent:
    prompt: |-
      The MCP server has been generated and built in /workspaces/generated-mcp-server/.
      The actual directory is /workspaces/ followed by the basename of "{{.Parameters.repo_name}}", then /generated-mcp-server.
      Find the generated-mcp-server directory under /workspaces/ and verify the server works:
      - Use @modelcontextprotocol/sdk to connect via StdioClientTransport
      - The server binary is build/index.js inside the generated-mcp-server directory
      - List tools and confirm getPosts and getPost exist
      - Call getPost with id=1 and confirm the response contains "Status: 200"
      - Print "All tests passed" on success, exit non-zero on failure
- task:
    command: |
      REPO_DIR=/workspaces/$(basename "{{.Parameters.repo_name}}") &&
      cd "$REPO_DIR" &&
      echo "node_modules/" > .gitignore &&
      echo "build/" >> .gitignore &&
      git add -A &&
      git commit -m "Add generated MCP server from OpenAPI spec" &&
      git push
